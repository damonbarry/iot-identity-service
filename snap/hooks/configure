#!/bin/sh


toml_kvp() {
	printf "%s = \"%s\"\n" "$1" "$2"
}

toml_new_section() {
	printf "\n\n"
	printf "[%s]\n" "$1"
}

get_hostname() {
	hostname="$(/usr/bin/hostnamectl hostname)"
	printf "$hostname"
}

snapctl get raw-config > /etc/aziot/config.toml

{
	toml_kvp "hostname" "$(get_hostname)"
} | tee /etc/aziot/keyd/config.d/01-snap.toml /etc/aziot/certd/config.d/01-snap.toml /etc/aziot/identityd/config.d/01-snap.toml /etc/aziot/tpmd/config.d/01-snap.toml

$SNAP/bin/aziotctl config apply
